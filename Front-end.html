<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼ˆSTGç¯å¢ƒï¼‰</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
      .table th, .table td { text-align: center; vertical-align: middle; white-space: nowrap; }
      .table th { width: auto; padding: 8px; }
      .file-name { max-width: 250px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
      .action-buttons { display: flex; gap: 5px; justify-content: center; flex-wrap: nowrap; }
      .rename-form { display: flex; gap: 5px; align-items: center; flex-wrap: nowrap; }
      .rename-input { width: 100px; font-size: 14px; padding: 2px; }
      .sort-icons { cursor: pointer; margin-left: 5px; }
      .btn-sm { padding: 4px 8px; font-size: 12px; }
      .kg-filter { margin-left: 5px; font-size: 14px; text-decoration: none; }
      /* æ–°å¢ï¿½ï¿½ï¿½å¼ï¼Œå±…ä¸­æ ‡é¢˜ */
      .header-title {
        text-align: center;
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 20px;
        margin-top: 30px; /* ç¡®ä¿ä¸é¡µé¢é¡¶éƒ¨æœ‰é€‚å½“çš„é—´è· */
        color: #333; /* è®¾ç½®æ ‡é¢˜é¢œè‰² */
      }
  </style>
  <script>
    // å®šä¹‰å½“å‰ç›®å½•åŠæ€»pdfæ•°é‡ï¼Œä¼ è‡ªåç«¯
    var currentPath = "{{ current_path }}";
    var totalPdfCount = {{ total_pdf_count }};
    var storageKey = "selected_pdfs_" + encodeURIComponent(currentPath);

    // ä»localStorageè·å–å½“å‰ç›®å½•çš„é€‰ä¸­åˆ—è¡¨
    function loadSelection() {
      var stored = localStorage.getItem(storageKey);
      return stored ? JSON.parse(stored) : [];
    }
    // ä¿å­˜é€‰ä¸­åˆ—è¡¨åˆ°localStorage
    function saveSelection(arr) {
      localStorage.setItem(storageKey, JSON.stringify(arr));
    }
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateCounter() {
      var selected = loadSelection();
      var counterElem = document.getElementById("selectionCounter");
      if(counterElem) {
        counterElem.innerText = "å·²é€‰ï¼š" + selected.length + " / æ€»ï¼š" + totalPdfCount;
      }
    }
    // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€ï¼Œæ ¹æ®æœ¬é¡µé€‰ä¸­çŠ¶æ€ï¼ˆä¸ data-inkg ç»“åˆï¼‰
    function updateBulkButtons() {
      let checkboxes = document.querySelectorAll("input[name='selected_files']");
      let selectedInPage = [];
      checkboxes.forEach(function(chk) {
        if(chk.checked) {
          selectedInPage.push(chk);
        }
      });
      // è·å–æ‰¹é‡æ“ä½œæŒ‰é’®
      let btnAdd = document.getElementById("btnBulkAdd");
      let btnRemove = document.getElementById("btnBulkRemove");
      if(selectedInPage.length === 0) {
        btnAdd.disabled = false;
        btnRemove.disabled = false;
        return;
      }
      let allInKG = selectedInPage.every(chk => chk.getAttribute("data-inkg") === "1");
      let allNotInKG = selectedInPage.every(chk => chk.getAttribute("data-inkg") === "0");
      btnAdd.disabled = allInKG;
      btnRemove.disabled = allNotInKG;
    }
    // å½“å¤é€‰æ¡†çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ›´æ–°localStorageä¸­å¯¹åº”çš„è®°å½•
    function onCheckboxChange(chk) {
      var selected = loadSelection();
      var val = chk.value;
      if(chk.checked) {
        if(selected.indexOf(val) === -1) {
          selected.push(val);
        }
      } else {
        var idx = selected.indexOf(val);
        if(idx !== -1) {
          selected.splice(idx, 1);
        }
      }
      saveSelection(selected);
      updateBulkButtons();
      updateCounter();
    }
    // é¡µé¢åŠ è½½æ—¶ï¼šå¯¹æœ¬é¡µå¤é€‰æ¡†è¿›è¡ŒçŠ¶æ€æ¢å¤
    function restoreCheckboxes() {
      var selected = loadSelection();
      let checkboxes = document.querySelectorAll("input[name='selected_files']");
      checkboxes.forEach(function(chk) {
        if(selected.indexOf(chk.value) !== -1) {
          chk.checked = true;
        }
        // ç»‘å®š change äº‹ä»¶
        chk.addEventListener("change", function() {
          onCheckboxChange(chk);
        });
      });
      updateBulkButtons();
      updateCounter();
    }
    // åœ¨æäº¤æ‰¹é‡æ“ä½œè¡¨å•å‰ï¼Œå°†æ‰€æœ‰å·²é€‰å¤é€‰æ¡†ï¼ˆè·¨é¡µä¿å­˜çš„ localStorage æ•°æ®ï¼‰å†™å…¥éšè—è¾“å…¥
    function prepareBulkSubmit(form) {
      var selected = loadSelection();
      var container = document.getElementById("bulkHiddenContainer");
      container.innerHTML = "";
      selected.forEach(function(val) {
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = "selected_files";
        input.value = val;
        container.appendChild(input);
      });
      return true;
    }
    // å…¨é€‰å½“å‰é¡µé¢æ‰€æœ‰pdf
    function selectAllPdfs() {
      let checkboxes = document.querySelectorAll("input[name='selected_files']");
      let selected = loadSelection();
      checkboxes.forEach(function(chk) {
        if(chk.value.toLowerCase().endsWith('.pdf')) {
          chk.checked = true;
          if(selected.indexOf(chk.value) === -1) {
            selected.push(chk.value);
          }
        }
      });
      saveSelection(selected);
      updateBulkButtons();
      updateCounter();
    }
    // å…¨ä¸é€‰å½“å‰é¡µé¢æ‰€æœ‰pdf
    function deselectAllPdfs() {
      let checkboxes = document.querySelectorAll("input[name='selected_files']");
      let selected = loadSelection();
      checkboxes.forEach(function(chk) {
        if(chk.value.toLowerCase().endsWith('.pdf')) {
          chk.checked = false;
          var idx = selected.indexOf(chk.value);
          if(idx !== -1) {
            selected.splice(idx, 1);
          }
        }
      });
      saveSelection(selected);
      updateBulkButtons();
      updateCounter();
    }
    window.addEventListener("DOMContentLoaded", function() {
      restoreCheckboxes();
    });
  </script>
</head>
<body>
  <div class="container my-4">
    <!-- æ·»åŠ æ ‡é¢˜ -->
    <div class="header-title">
      æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼ˆSTGç¯å¢ƒï¼‰
    </div>

    {# åˆ¤æ–­æ˜¯å¦å¤„äºæ‰¹é‡æ“ä½œæ¨¡å¼ï¼Œé€šè¿‡ bulk å‚æ•° #}
    {% set bulk_mode = bulk %}
    <div class="mb-3">
      {% if not bulk_mode %}
        <div class="d-flex gap-2">
          <a href="{{ url_for('show_kg_files') }}" class="btn btn-primary">æ˜¾ç¤ºçŸ¥è¯†å›¾è°±ä¸­çš„æ–‡ä»¶åˆ—è¡¨</a>
          <a href="/check_uploaded_pdfs?current_path={{ current_path }}" class="btn btn-primary">æ£€æŸ¥ä¸Šä¼ çš„PDF</a>
        </div>
      {% endif %}
    </div>
    <form id="filterForm" action="/" method="get" class="d-flex gap-2 mb-3">
      <input type="text" class="form-control" name="search" placeholder="ğŸ” æœç´¢æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹" value="{{ search }}">
      <input type="hidden" name="current_path" value="{{ current_path }}">  <!-- æ·»åŠ éšè—å­—æ®µä¼ é€’å½“å‰è·¯å¾„ -->
      <button type="submit" class="btn btn-primary">æœç´¢</button>
      {% if search and search.strip() != '' %}
        <a href="/" class="btn btn-secondary">è¿”å›å…¨éƒ¨</a>
      {% endif %}
      {% if filter_kg is not none %}
        <input type="hidden" name="filter_kg" value="{{ filter_kg }}">
      {% endif %}
      {% if bulk_mode %}
        <input type="hidden" name="bulk" value="1">
      {% endif %}
    </form>
    {% if current_path != '/data/' %}
      <a href="{{ url_for('index', current_path=current_path.rsplit('/', 1)[0] or '/data/', search=search, filter_kg=filter_kg, bulk=( '1' if bulk_mode else None)) }}" class="btn btn-secondary mb-3">è¿”å›ä¸Šçº§</a>
    {% endif %}
    <form action="/create_folder" method="post" class="mb-3">
      <input type="text" name="folder_name" class="form-control" placeholder="è¾“å…¥æ–‡ä»¶å¤¹åç§°">
      <input type="hidden" name="current_path" value="{{ current_path }}">
      <button type="submit" class="btn btn-success mt-2">æ–°å»ºæ–‡ä»¶å¤¹</button>
    </form>
    <form action="/upload" method="post" enctype="multipart/form-data" class="mb-3">
      <input type="file" name="file" class="form-control">
      <input type="hidden" name="current_path" value="{{ current_path }}">
      <button type="submit" class="btn btn-success mt-2">ä¸Šä¼ æ–‡ä»¶</button>
    </form>
    <form action="/upload_folder" method="post" enctype="multipart/form-data" class="mb-3">
      <input type="file" name="folder" class="form-control" webkitdirectory directory multiple>
      <input type="hidden" name="current_path" value="{{ current_path }}">
      <button type="submit" class="btn btn-success mt-2">ä¸Šä¼ æ–‡ä»¶å¤¹</button>
    </form>

    <table class="table table-bordered table-striped mt-3">
      <thead>
        <tr>
          {% if bulk_mode %}
            <th>é€‰æ‹©</th>
          {% endif %}
          {% for col in [('name', 'åç§°'), ('size', 'å¤§å°'), ('mtime', 'æ›´æ–°æ—¶é—´')] %}
            <th>
              {{ col[1] }}
              <span class="sort-icons" onclick="sortTable('{{ col[0] }}', 'false')">â¬†</span>
              <span class="sort-icons" onclick="sortTable('{{ col[0] }}', 'true')">â¬‡</span>
            </th>
          {% endfor %}
          <th>
            çŸ¥è¯†å›¾è°±
            <a href="{{ url_for('index', current_path=current_path, filter_kg='1', search=search, bulk=( '1' if bulk_mode else None)) }}" title="ç­›é€‰åœ¨å›¾è°±ä¸­" class="kg-filter">âœ”</a>
            <a href="{{ url_for('index', current_path=current_path, filter_kg='0', search=search, bulk=( '1' if bulk_mode else None)) }}" title="ç­›é€‰ä¸åœ¨å›¾è°±ä¸­" class="kg-filter">âœ–</a>
            <a href="{{ url_for('index', current_path=current_path, search=search) }}" title="é‡ç½®ç­›é€‰" class="kg-filter">é‡ç½®</a>
          </th>
          <th>
            æ“ä½œ
            {% if bulk_mode %}
              [<a href="{{ url_for('index', current_path=current_path, search=search, filter_kg=filter_kg) }}" class="text-decoration-none">å…³é—­æ‰¹é‡æ“ä½œ</a>]
            {% else %}
              [<a href="{{ url_for('index', current_path=current_path, search=search, filter_kg=filter_kg, bulk='1') }}" class="text-decoration-none">å¼€å¯æ‰¹é‡æ“ä½œ</a>]
            {% endif %}
          </th>
        </tr>
      </thead>
      <tbody>
        {% for item in files_and_folders %}
          <tr>
            {% if bulk_mode %}
              <td>
                {% if item.type == 'file' %}
                  <input type="checkbox" name="selected_files" value="{{ item.name }}" data-inkg="{{ 1 if item.in_kg else 0 }}">
                {% endif %}
              </td>
            {% endif %}
            <td class="file-name">
              {% if item.type == 'folder' %}
                <a href="{{ url_for('index', current_path=current_path.rstrip('/') + '/' + item.name, search=search, filter_kg=filter_kg, bulk=( '1' if bulk_mode else None)) }}">{{ item.name }}</a>
              {% else %}
                {{ item.name }}
              {% endif %}
            </td>
            <td>{{ item.size if item.type == 'file' else '-' }}</td>
            <td>{{ item.mtime | datetimeformat }}</td>
            <td>
              {% if item.type == 'file' %}
                {% if item.in_kg %}
                  <span class="badge bg-success">åœ¨å›¾è°±ä¸­</span>
                  <form action="/update_kg" method="post" style="display:inline;">
                    <input type="hidden" name="action" value="remove">
                    <input type="hidden" name="file_name" value="{{ item.base_name }}">
                    <input type="hidden" name="current_path" value="{{ current_path }}">
                    <button type="submit" class="btn btn-sm btn-warning">ç§»å‡ºå›¾è°±</button>
                  </form>
                {% else %}
                  <span class="badge bg-secondary">ä¸åœ¨å›¾è°±ä¸­</span>
                  <form action="/update_kg" method="post" style="display:inline;">
                    <input type="hidden" name="action" value="add">
                    <input type="hidden" name="file_name" value="{{ item.base_name }}">
                    <input type="hidden" name="current_path" value="{{ current_path }}">
                    <button type="submit" class="btn btn-sm btn-success">ç§»å…¥å›¾è°±</button>
                  </form>
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <div class="action-buttons">
                <a href="{{ url_for('serve_file', filename=item.name, current_path=current_path) }}" class="btn btn-sm btn-info">ä¸‹è½½</a>
                {% if item.type == 'folder' %}
                  <a href="{{ url_for('delete_file_or_folder', filename=item.name, current_path=current_path) }}" class="btn btn-sm btn-danger" onclick="if(confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ä»¶å¤¹å—ï¼Ÿ')) { this.href = this.href + (this.href.indexOf('?') > -1 ? '&' : '?') + 'confirmed=true'; } else { return false; }">åˆ é™¤</a>
                {% else %}
                  <a href="{{ url_for('delete_file_or_folder', filename=item.name, current_path=current_path) }}" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ä»¶å—ï¼Ÿ');">åˆ é™¤</a>
                {% endif %}
                <form action="{{ url_for('rename_file_or_folder', old_name=item.name) }}" method="post" class="rename-form">
                  <input type="text" name="new_name" class="form-control rename-input" placeholder="æ–°åç§°" required>
                  <button type="submit" class="btn btn-sm btn-warning">é‡å‘½å</button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if bulk_mode %}
      <form id="bulkForm" action="/bulk_action" method="post" onsubmit="return prepareBulkSubmit(this);">
        <input type="hidden" name="current_path" value="{{ current_path }}">
        <div id="bulkHiddenContainer"></div>
        <div class="d-flex gap-2 mb-3">
          <button type="submit" name="action" value="delete" class="btn btn-danger">æ‰¹é‡åˆ é™¤</button>
          <button type="submit" id="btnBulkAdd" name="action" value="add" class="btn btn-success">æ‰¹é‡ç§»å…¥å›¾è°±</button>
          <button type="submit" id="btnBulkRemove" name="action" value="remove" class="btn btn-warning">æ‰¹é‡ç§»å‡ºå›¾è°±</button>
          <button type="button" class="btn btn-secondary" onclick="selectAllPdfs()">å…¨é€‰å½“å‰é¡µé¢</button>
          <button type="button" class="btn btn-secondary" onclick="deselectAllPdfs()">å…¨ä¸é€‰å½“å‰é¡µé¢</button>
          <span id="selectionCounter" class="align-self-center ms-2"></span>
        </div>
      </form>
    {% endif %}
    <div class="d-flex justify-content-end align-items-center">
      <nav>
        <ul class="pagination mb-0">
          {% for i in range(1, total_pages + 1) %}
            <li class="page-item {% if i == page %}active{% endif %}">
              <a class="page-link" href="?page={{ i }}&per_page={{ per_page }}&sort_by={{ sort_by }}&reverse={{ reverse }}{% if filter_kg is not none and filter_kg != '' %}&filter_kg={{ filter_kg }}{% endif %}{% if bulk_mode %}&bulk=1{% endif %}">{{ i }}</a>
            </li>
          {% endfor %}
        </ul>
      </nav>
      <div class="ms-3">
        <label for="per_page_select" class="me-1">æ¯é¡µæ˜¾ç¤ºï¼š</label>
        <select id="per_page_select" name="per_page" class="form-select d-inline w-auto" onchange="updatePerPage()">
          {% for num in [5, 10, 20, 50] %}
            <option value="{{ num }}" {% if num == per_page %}selected{% endif %}>{{ num }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
</body>
</html>
